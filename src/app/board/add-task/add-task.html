<div class="add-task-container" [class.mobile]="breakpointService.isMobile()" [class.show-task-form]="showMobileTaskForm">
  <div class="task-content">
    <h1 class="task-heading">{{ isEditMode ? 'Edit Task' : 'Add Task' }}</h1>
    <form [formGroup]="form" (ngSubmit)="submit()">
      <div class="form-content">
        <div class="left-side">
          <!-- Title -->
          <div class="form-group form-group-height">
            <div class="input-group">
              <label for="task-overlay-title">Title <span class="required-asterisk">*</span></label>
              <input type="text" id="task-overlay-title" formControlName="title" placeholder="Enter a title"
                [ngClass]="{'valid-field': isFieldValid('title'), 'invalid-field': isFieldInvalid('title')}">
              @if (isFieldInvalid('title')) {
              <div class="validation-error">
                {{ getValidationMessage('title') }}
              </div>
              }
            </div>
          </div>

          <!-- Description -->
          <div class="form-group">
            <label for="description">Description</label>
            <div class="input-group">
              <textarea class="textarea-form-group" id="task-overlay-description" formControlName="description"
                placeholder="Enter a description"
                [ngClass]="{'valid-field': isFieldValid('description'), 'invalid-field': isFieldInvalid('description')}"></textarea>
              @if (isFieldInvalid('description')) {
              <div class="validation-error">
                {{ getValidationMessage('description') }}
              </div>
              }
            </div>
          </div>

          <!-- Due Date -->
          <div class="form-group">
            <label for="dueDate">Due Date <span class="required-asterisk">*</span></label>
            <div class="input-group">
              <input type="date" id="task-overlay-dueDate" formControlName="dueDate"
                [ngClass]="{'valid-field': isFieldValid('dueDate'), 'invalid-field': isFieldInvalid('dueDate')}">
              @if (isFieldInvalid('dueDate')) {
              <div class="validation-error">
                {{ getValidationMessage('dueDate') }}
              </div>
              }
            </div>
          </div>
        </div>
        <div class="horizontal-line">&nbsp;</div>
        <div class="right-side">
          <div class="form-group form-group-height">
            <label>Priority</label>
            <div class="priority-buttons">
              <button type="button" class="priority-btn urgent"
                [ngClass]="{'selected': form.get('priority')?.value === 'urgent'}" (click)="setPriority('urgent')">
                <span>Urgent</span>
                <span class="priority-icon">
                  <svg width="21" height="15" viewBox="0 0 21 15" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g clip-path="url(#task-overlay-urgent-clip)">
                      <path
                        d="M19.5708 14.755C19.3361 14.7554 19.1076 14.6805 18.9187 14.5414L10.6666 8.45824L2.4146 14.5414C2.29874 14.627 2.16716 14.6889 2.02736 14.7237C1.88756 14.7584 1.74228 14.7653 1.59981 14.7439C1.45734 14.7226 1.32048 14.6734 1.19703 14.5992C1.07359 14.525 0.965978 14.4272 0.880349 14.3114C0.79472 14.1957 0.732748 14.0642 0.697971 13.9245C0.663194 13.7848 0.656294 13.6396 0.677664 13.4973C0.720823 13.2097 0.876514 12.9511 1.11049 12.7783L10.0146 6.20786C10.2033 6.06826 10.4319 5.99292 10.6666 5.99292C10.9014 5.99292 11.13 6.06826 11.3187 6.20786L20.2228 12.7783C20.4087 12.9153 20.5466 13.1074 20.6168 13.3272C20.6869 13.5471 20.6858 13.7835 20.6135 14.0027C20.5411 14.2219 20.4014 14.4126 20.2141 14.5477C20.0269 14.6828 19.8017 14.7554 19.5708 14.755Z" />
                      <path
                        d="M19.5708 9.00581C19.3361 9.00621 19.1076 8.93136 18.9187 8.79226L10.6667 2.7091L2.4146 8.79226C2.18063 8.96507 1.88754 9.03793 1.59981 8.9948C1.31209 8.95167 1.05329 8.7961 0.880353 8.5623C0.707418 8.3285 0.63451 8.03563 0.677669 7.74811C0.720828 7.4606 0.876518 7.20199 1.11049 7.02919L10.0146 0.45871C10.2033 0.319119 10.4319 0.243774 10.6667 0.243774C10.9014 0.243774 11.13 0.319119 11.3187 0.45871L20.2228 7.02919C20.4087 7.1661 20.5466 7.35822 20.6168 7.5781C20.6869 7.79797 20.6858 8.03438 20.6135 8.25356C20.5412 8.47274 20.4014 8.6635 20.2141 8.79859C20.0269 8.93368 19.8017 9.0062 19.5708 9.00581Z" />
                    </g>
                    <defs>
                      <clipPath id="task-overlay-urgent-clip">
                        <rect width="20" height="14.5098" fill="white" transform="translate(0.666504 0.245117)" />
                      </clipPath>
                    </defs>
                  </svg>
                </span>
              </button>
              <button type="button" class="priority-btn medium"
                [ngClass]="{'selected': form.get('priority')?.value === 'medium'}" (click)="setPriority('medium')">
                <span>Medium</span>
                <span class="priority-icon">
                  <svg width="21px" height="15px" version="1.1" xmlns="http://www.w3.org/2000/svg"
                    xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/">
                    <g>
                      <g>
                        <clipPath id="task-overlay-medium-clip">
                          <rect x="0.667" y="0.245" width="20" height="14.51" />
                        </clipPath>
                        <g clip-path="url(#task-overlay-medium-clip)">
                          <g transform="matrix(0.991674,0,0,1,-0.181842,3.30832)">
                            <path
                              d="M19.76,7.917L1.951,7.917C1.661,7.917 1.382,7.801 1.176,7.594C0.971,7.387 0.855,7.106 0.855,6.813C0.855,6.521 0.971,6.24 1.176,6.033C1.382,5.826 1.661,5.709 1.951,5.709L19.76,5.709C20.05,5.709 20.329,5.826 20.535,6.033C20.74,6.24 20.856,6.521 20.856,6.813C20.856,7.106 20.74,7.387 20.535,7.594C20.329,7.801 20.05,7.917 19.76,7.917Z" />
                            <path
                              d="M19.76,2.674L1.951,2.674C1.661,2.674 1.382,2.558 1.176,2.351C0.971,2.144 0.855,1.863 0.855,1.57C0.855,1.277 0.971,0.997 1.176,0.789C1.382,0.582 1.661,0.466 1.951,0.466L19.76,0.466C20.05,0.466 20.329,0.582 20.535,0.789C20.74,0.997 20.856,1.277 20.856,1.57C20.856,1.863 20.74,2.144 20.535,2.351C20.329,2.558 20.05,2.674 19.76,2.674Z" />
                          </g>
                        </g>
                      </g>
                    </g>
                  </svg>
                </span>
              </button>
              <button type="button" class="priority-btn low"
                [ngClass]="{'selected': form.get('priority')?.value === 'low'}" (click)="setPriority('low')">
                <span>Low</span>
                <span class="priority-icon">
                  <svg width="21px" height="15px" version="1.1" xmlns="http://www.w3.org/2000/svg"
                    xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/"
                    style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
                    <g>
                      <clipPath id="task-overlay-low-clip">
                        <rect x="0.667" y="0.245" width="20" height="14.51" />
                      </clipPath>
                      <g clip-path="url(#task-overlay-low-clip)">
                        <g transform="matrix(-1,1.22465e-16,-1.22465e-16,-1,21.3341,14.9998)">
                          <path
                            d="M19.571,14.755C19.336,14.755 19.108,14.681 18.919,14.541L10.667,8.458L2.415,14.541C2.299,14.627 2.167,14.689 2.027,14.724C1.888,14.758 1.742,14.765 1.6,14.744C1.457,14.723 1.32,14.673 1.197,14.599C1.074,14.525 0.966,14.427 0.88,14.311C0.795,14.196 0.733,14.064 0.698,13.925C0.663,13.785 0.656,13.64 0.678,13.497C0.721,13.21 0.877,12.951 1.11,12.778L10.015,6.208C10.203,6.068 10.432,5.993 10.667,5.993C10.901,5.993 11.13,6.068 11.319,6.208L20.223,12.778C20.409,12.915 20.547,13.107 20.617,13.327C20.687,13.547 20.686,13.784 20.613,14.003C20.541,14.222 20.401,14.413 20.214,14.548C20.027,14.683 19.802,14.755 19.571,14.755Z" />
                        </g>
                        <g transform="matrix(-1,1.22465e-16,-1.22465e-16,-1,21.3341,14.9998)">
                          <path
                            d="M19.571,9.006C19.336,9.006 19.108,8.931 18.919,8.792L10.667,2.709L2.415,8.792C2.181,8.965 1.888,9.038 1.6,8.995C1.312,8.952 1.053,8.796 0.88,8.562C0.707,8.329 0.635,8.036 0.678,7.748C0.721,7.461 0.877,7.202 1.11,7.029L10.015,0.459C10.203,0.319 10.432,0.244 10.667,0.244C10.901,0.244 11.13,0.319 11.319,0.459L20.223,7.029C20.409,7.166 20.547,7.358 20.617,7.578C20.687,7.798 20.686,8.034 20.613,8.254C20.541,8.473 20.401,8.664 20.214,8.799C20.027,8.934 19.802,9.006 19.571,9.006Z" />
                        </g>
                      </g>
                    </g>
                  </svg>
                </span>
              </button>
            </div>
          </div>
          <!-- Assigned To -->
          <div class="form-group">
            <label for="assignedTo">Assigned to</label>

            <!-- Custom Multi-Select Dropdown -->
            <div class="custom-select-wrapper">
              <div class="custom-select-header" (click)="toggleDropdown()" [class.open]="isDropdownOpen">
                <span class="placeholder">
                  @if (form.get('assignedTo')?.value?.length > 0) {
                  {{ form.get('assignedTo')?.value?.length }} contact(s) selected
                  } @else {
                  Select contacts
                  }
                </span>
                <span class="dropdown-arrow">
                  <svg width="14" height="8" viewBox="0 0 14 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M7 5.5L11.5 1L12.5 2L7 7.5L1.5 2L2.5 1L7 5.5Z" fill="currentColor" />
                  </svg>
                </span>
              </div>

              @if (isDropdownOpen) {
              <div class="custom-select-dropdown">
                @for (contact of ContactsList; track contact.id) {
                @if (contact.id) {
                <div class="contact-option" [class.selected]="isContactSelected(contact.id)"
                  (click)="toggleContact(contact.id)">
                  <div class="contact-option-content">
                    <div class="circle-small" [style.backgroundColor]="getColor(contact.name)">
                      {{ getInitials(contact.name) }}
                    </div>
                    <span class="contact-name">{{ contact.name }}</span>
                  </div>
                  <div class="checkbox-indicator">
                    @if (isContactSelected(contact.id)) {
                    ✓
                    }
                  </div>
                </div>
                }
                }
              </div>
              }
            </div>

            <!-- Display of assigned contacts with initials -->
            @if (form.get('assignedTo')?.value && form.get('assignedTo')?.value.length > 0) {
            <div class="assigned-contacts-display">
              <label>Selected contacts:</label>
              <div class="contacts-list">
                @for (contactId of form.get('assignedTo')?.value; track contactId) {
                @if (getContactById(contactId); as contact) {
                <div class="contact-item-display">
                  <div class="circle" [style.backgroundColor]="getColor(contact.name)">
                    {{ getInitials(contact.name) }}
                  </div>
                </div>
                }
                }
              </div>
            </div>
            }

            @if (isFieldInvalid('assignedTo')) {
            <div class="validation-error">
              {{ getValidationMessage('assignedTo') }}
            </div>
            }
          </div>

          <!-- Category -->
          <div class="form-group form-group-height">
            <label for="category">Category <span class="required-asterisk">*</span></label>

            <!-- Custom Single-Select Dropdown -->
            <div class="custom-select-wrapper">
              <div class="custom-select-header" (click)="toggleCategoryDropdown()"
                [class.open]="isCategoryDropdownOpen">
                <span class="placeholder">
                  @if (form.get('category')?.value) {
                  {{ form.get('category')?.value }}
                  } @else {
                  Select category
                  }
                </span>
                <span class="dropdown-arrow">
                  <svg width="14" height="8" viewBox="0 0 14 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M7 5.5L11.5 1L12.5 2L7 7.5L1.5 2L2.5 1L7 5.5Z" fill="currentColor" />
                  </svg>
                </span>
              </div>

              @if (isCategoryDropdownOpen) {
              <div class="custom-select-dropdown">
                <div class="category-option" [class.selected]="form.get('category')?.value === 'User Story'"
                  (click)="selectCategory('User Story')">
                  <span>User Story</span>
                </div>
                <div class="category-option" [class.selected]="form.get('category')?.value === 'Technical Task'"
                  (click)="selectCategory('Technical Task')">
                  <span>Technical Task</span>
                </div>
              </div>
              }
            </div>

            @if (isFieldInvalid('category')) {
            <div class="validation-error">
              {{ getValidationMessage('category') }}
            </div>
            }
          </div>

          <!-- Subtasks -->
          <div class="form-group">
            <label for="subtask">Subtasks</label>
            <div class="input-group">
              <div class="subtasks add-subtask">
                <input type="text" [formControl]="subtaskControls[subtaskControls.length - 1]"
                  placeholder="Add new subtask">
                @if (subtaskControls.length > 1) {
                <button type="button" class="minus-icon" (click)="removeSubtask(subtaskControls.length - 1)">−</button>
                }
                <button type="button" class="plus-icon" (click)="addSubtask()">+</button>
              </div>
            </div>

            @if (subtaskControls.length > 1) {
            <div class="subtasks-list-display">
              <div class="subtasks-list">
                @for (control of subtaskControls.slice(0, -1); track $index) {
                @if (control.value) {
                <div class="subtask-item">
                  <div class="subtask-content">
                    <span class="subtask-bullet">•</span>
                    <span class="subtask-text">{{ control.value }}</span>
                  </div>
                  <div class="subtask-actions">
                    <div class="action-icon delete-icon" (click)="removeSubtask($index)" title="Delete subtask">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 17 18" fill="none">
                        <path
                          d="M3.5 18C2.95 18 2.47917 17.8042 2.0875 17.4125C1.69583 17.0208 1.5 16.55 1.5 16V3C1.21667 3 0.979167 2.90417 0.7875 2.7125C0.595833 2.52083 0.5 2.28333 0.5 2C0.5 1.71667 0.595833 1.47917 0.7875 1.2875C0.979167 1.09583 1.21667 1 1.5 1H5.5C5.5 0.716667 5.59583 0.479167 5.7875 0.2875C5.97917 0.0958333 6.21667 0 6.5 0H10.5C10.7833 0 11.0208 0.0958333 11.2125 0.2875C11.4042 0.479167 11.5 0.716667 11.5 1H15.5C15.7833 1 16.0208 1.09583 16.2125 1.2875C16.4042 1.47917 16.5 1.71667 16.5 2C16.5 2.28333 16.4042 2.52083 16.2125 2.7125C16.0208 2.90417 15.7833 3 15.5 3V16C15.5 16.55 15.3042 17.0208 14.9125 17.4125C14.5208 17.8042 14.05 18 13.5 18H3.5ZM3.5 3V16H13.5V3H3.5ZM5.5 13C5.5 13.2833 5.59583 13.5208 5.7875 13.7125C5.97917 13.9042 6.21667 14 6.5 14C6.78333 14 7.02083 13.9042 7.2125 13.7125C7.40417 13.5208 7.5 13.2833 7.5 13V6C7.5 5.71667 7.40417 5.47917 7.2125 5.2875C7.02083 5.09583 6.78333 5 6.5 5C6.21667 5 5.97917 5.09583 5.7875 5.2875C5.59583 5.47917 5.5 5.71667 5.5 6V13ZM9.5 13C9.5 13.2833 9.59583 13.5208 9.7875 13.7125C9.97917 13.9042 10.2167 14 10.5 14C10.7833 14 11.0208 13.9042 11.2125 13.7125C11.4042 13.5208 11.5 13.2833 11.5 13V6C11.5 5.71667 11.4042 5.47917 11.2125 5.2875C11.0208 5.09583 10.7833 5 10.5 5C10.2167 5 9.97917 5.09583 9.7875 5.2875C9.59583 5.47917 9.5 5.71667 9.5 6V13Z"
                          fill="currentColor" />
                      </svg>
                    </div>
                  </div>
                </div>
                }
                }
              </div>
            </div>
            }
          </div>

          <!-- Buttons -->
          <div class="button-group justify-end">
            <button type="button" class="cancel-btn btn" (click)="cancel()">Cancel X</button>
            <button type="submit" class="create-btn btn">
              {{ isEditMode ? 'Update' : 'Create' }}
              <span class="check">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="13" viewBox="0 0 16 13" fill="none">
                  <path
                    d="M5.55057 9.65L14.0256 1.175C14.2256 0.975 14.4631 0.875 14.7381 0.875C15.0131 0.875 15.2506 0.975 15.4506 1.175C15.6506 1.375 15.7506 1.6125 15.7506 1.8875C15.7506 2.1625 15.6506 2.4 15.4506 2.6L6.25057 11.8C6.05057 12 5.81724 12.1 5.55057 12.1C5.28391 12.1 5.05057 12 4.85057 11.8L0.550573 7.5C0.350573 7.3 0.25474 7.0625 0.263073 6.7875C0.271407 6.5125 0.375573 6.275 0.575573 6.075C0.775573 5.875 1.01307 5.775 1.28807 5.775C1.56307 5.775 1.80057 5.875 2.00057 6.075L5.55057 9.65Z" />
                </svg>
              </span>
            </button>
          </div>
        </div>
      </div>
      <div>
        <span><span class="required-asterisk">*</span> This field is required</span>
      </div>
    </form>
  </div>
</div>
